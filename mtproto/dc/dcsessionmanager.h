#ifndef DCSESSIONMANAGER_H
#define DCSESSIONMANAGER_H

#include <QObject>
#include "dcsession.h"
#include "dcauthorization.h"
#include "autogenerated/telegramapi.h"

#define DCSessionManager_instance DCSessionManager::instance()
#define DC_MainSession DCSessionManager::instance()->mainSession()
#define DC_CreateSession(dcid) DCSessionManager::instance()->createSession(dcid, false)
#define DC_CreateFileSession(dcid) DCSessionManager::instance()->createSession(dcid, true)
#define DC_CloseSession(dcsession) DCSessionManager::instance()->closeSession(dcsession)
#define DC_InitializeSession(dcsession) DCSessionManager::instance()->initializeSession(dcsession)

class DCSessionManager: public QObject
{
    Q_OBJECT

    private:
        DCSessionManager(QObject* parent = 0);
        DC* createDC(const QString& host, qint16 port, int id, bool filedc);
        DC* createDC(int id, bool filedc);
        void updateMainDc(int maindcid);
        void doAuthorization(DCSession* dcsession);
        void doSessionReady(DCSession* dcsession);

    public:
        static DCSessionManager* instance();

    public:
        DCSession* mainSession() const;
        DCSession* createMainSession(const DCConfig& dcconfig);
        DCSession* createMainSession(const QString& host, qint16 port, int dcid);
        DCSession* createMainSession(int dcid);
        DCSession* createSession(int dcid, bool filedc);
        void initializeSession(DCSession* dcsession);
        void closeSession(DCSession* dcsession);

    private slots:
        void onAuthorized(DC *dc);
        void onAuthorizationImported(DC *dc);
        void onAuthorizationReply(MTProtoReply *mtreply);
        void onMigrateDC(int fromdcid, int todcid);
        void onDCDisconnected();

    signals:
        void sessionReady(DCSession* session);
        void phoneCodeError(QString errormessage);
        void floodLock(int seconds);
        void invalidPassword();
        void sessionPasswordNeeded();
        void mainSessionConnectedChanged();

    private:
        QHash<DC*, DCAuthorization*> _dcauthorizations;
        QHash<int, DC*> _dclist;
        QHash<int, DC*> _filedclist;
        DCSession* _mainsession;

    private:
        static DCSessionManager* _sessionmanager;
};

#endif // DCSESSIONMANAGER_H
