#ifndef DCSESSIONMANAGER_H
#define DCSESSIONMANAGER_H

#include <QObject>
#include "autogenerated/telegramapi.h"
#include "dcauthorization.h"
#include "dcsession.h"

#define DCSessionManager_instance DCSessionManager::instance()
#define DC_MainSession DCSessionManager::instance()->mainSession()
#define DC_CreateSession(dcconfig) DCSessionManager::instance()->createSession(dcconfig, false)
#define DC_CreateFileSession(dcconfig) DCSessionManager::instance()->createSession(dcconfig, true)
#define DC_CreateMainSession(dcconfig) DCSessionManager::instance()->createMainSession(dcconfig)
#define DC_CloseSession(dcsession) DCSessionManager::instance()->closeSession(dcsession)
#define DC_InitializeSession(dcsession) DCSessionManager::instance()->initializeSession(dcsession)
#define DC_OwnSession(sessionid) DCSessionManager::instance()->ownSession(sessionid)

class DCSessionManager: public QObject
{
    Q_OBJECT

    private:
        DCSessionManager(QObject* parent = 0);
        DC* createDC(DCConfig* dcconfig, bool filedc);
        void doRestoreSessions(const QList<DC*>& dclist) const;
        void doAuthorization(DCSession* dcsession);
        void doSessionReady(DCSession* dcsession);

    public:
        static DCSessionManager* instance();
        DCSession* mainSession() const;
        DCSession* createMainSession(DCConfig* dcconfig);
        DCSession* createSession(DCConfig* dcconfig, bool filedc);
        bool ownSession(TLLong sessionid);
        void restoreSessions() const;
        void initializeSession(DCSession* dcsession);
        void closeSession(DCSession* dcsession);

    private slots:
        void updateSessionId(TLLong oldsessionid);
        void onAuthorized(DC *dc);
        void onAuthorizationImported(DC *dc);
        void onAuthorizationReply(MTProtoReply *mtreply);
        void onMigrateDC(DCConfig *fromdcconfig, int todcid);
        void onDCDisconnected();

    signals:
        void sessionReady(DCSession* session);
        void phoneCodeError(QString errormessage);
        void floodLock(int seconds);
        void invalidPassword();
        void sessionPasswordNeeded();
        void mainSessionTimeout(int seconds);
        void mainSessionConnectedChanged();

    private:
        QHash<DC*, DCAuthorization*> _dcauthorizations;
        QHash<DCConfig::Id, DC*> _dclist;
        QHash<DCConfig::Id, DC*> _filedclist;
        QHash<TLLong, DCSession*> _activesessions;
        DCSession* _mainsession;

    private:
        static DCSessionManager* _sessionmanager;
};

#endif // DCSESSIONMANAGER_H
