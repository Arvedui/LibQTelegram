#ifndef DC_H
#define DC_H

#include "dcconnection.h"
#include "../../autogenerated/mtproto/decompiler/mtprotodecompiler.h"
#include "../mtprotorequest.h"
#include "../mtprotoreply.h"
#include "../mtprotoservicehandler.h"

class DC : public DCConnection
{
    Q_OBJECT

    public:
        explicit DC(const QString& address, qint16 port, int dcid, QObject *parent = 0);
        int id() const;

    public:
        void sendPendingRequests();
        TLLong send(MTProtoRequest *req);
        MTProtoRequest* popRequest(TLLong msgid);

    private:
        void decompile(int direction, TLLong messageid, const QByteArray &body);
        void handleReply(const QByteArray& message);
        TLInt generateContentMsgNo();
        TLInt getPacketLength();

    private slots:
        void handleReply(MTProtoReply* mtreply);
        void onDCReadyRead();

    signals:
        void authorizationReply(MTProtoReply* mtreply);
        void configurationReceived(Config* config);
        void migrateDC(int dcid);

    private:
        QList<MTProtoRequest*> _pendingrequests;
        QHash<TLLong, MTProtoRequest*> _requests;
        MTProtoServiceHandler* _mtservicehandler;
        MTProtoDecompiler* _mtdecompiler;
        TLInt _lastpacketlen;
        TLInt _contentmsgno;
        int _dcid;
};

#endif // DC_H
