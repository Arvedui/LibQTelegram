#include "telegramruntime.h"
#include "../mtproto/mtprotorequest.h"
#include "../mtproto/mtprotoupdatehandler.h"
#include "../mtproto/dc/dcsessionmanager.h"
#include "../autogenerated/telegramapi.h"
#include "cache/telegramcache.h"

TelegramRuntime* TelegramRuntime::_instance = NULL;

TelegramRuntime::TelegramRuntime(QObject *parent) : QObject(parent)
{
    connect(UPDATE_HANDLER, &MTProtoUpdateHandler::newUpdate, this, &TelegramRuntime::onUpdate);
    connect(UPDATE_HANDLER, &MTProtoUpdateHandler::newMessage, this, &TelegramRuntime::onNewMessage);

    connect(UPDATE_HANDLER, &MTProtoUpdateHandler::newChat, [](Chat* chat) {
        TELEGRAM_CACHE_OBJECT(chat);
    });

    connect(UPDATE_HANDLER, &MTProtoUpdateHandler::newUser, [](User* user) {
        TELEGRAM_CACHE_OBJECT(user);
    });

    this->updateDialogs();
}

QList<DialogObject *> TelegramRuntime::dialogList() const
{
    return this->_dialogs.values();
}

void TelegramRuntime::onNewMessage(Message* message)
{
    MessageObject* messageobj = this->createMessageObject(message);
    TLInt dialogid = TelegramHelper::dialogIdentifier(message);

    if(this->_dialogs.contains(dialogid))
    {
        DialogObject* dialogobj = this->_dialogs[dialogid];
        dialogobj->setTopMessage(messageobj);

        emit dialogsChanged();
    }
}

void TelegramRuntime::onUpdate(Update *update)
{
    if(update->constructorId() == TLTypes::UpdateNewMessage)
        this->onNewMessage(update->messageUpdatenewmessage());
}

void TelegramRuntime::updateDialogs()
{
    const QHash<TLInt, Dialog*>& dialogs = TELEGRAM_CACHE->dialogs();

    foreach(TLInt dialogid, dialogs.keys())
    {
        Dialog* dialog = dialogs[dialogid];
        this->updateDialog(dialog);
    }
}

DialogObject *TelegramRuntime::updateDialog(Dialog *dialog)
{
    DialogObject* dialogobj = this->runtimeObject(this->_dialogs, dialog);
    MessageObject* topmessageobj = this->createMessageObject(TELEGRAM_CACHE->message(dialog->topMessage()));

    dialogobj->setTopMessage(topmessageobj);

    if(TelegramHelper::isChannel(dialog))
        dialogobj->setChat(TELEGRAM_CACHE->chat(dialog->peer()->channelId()));
    else if(TelegramHelper::isChat(dialog))
        dialogobj->setChat(TELEGRAM_CACHE->chat(dialog->peer()->chatId()));
    else
        dialogobj->setUser(TELEGRAM_CACHE->user(dialog->peer()->userId()));

    return dialogobj;
}

MessageObject *TelegramRuntime::createMessageObject(Message *message)
{
    MessageObject* messageobj = this->runtimeObject(this->_messages, message);
    messageobj->setMessage(message);

    if(message->fromId())
        messageobj->setFromUser(TELEGRAM_CACHE->user(message->fromId()));

    return messageobj;
}

TelegramRuntime *TelegramRuntime::runtime()
{
    if(!TelegramRuntime::_instance)
        TelegramRuntime::_instance = new TelegramRuntime();

    return TelegramRuntime::_instance;
}
